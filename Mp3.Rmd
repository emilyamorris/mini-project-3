---
title: "Mini_project_3"
author: "Emily M., Sylvie L., and Hannah R.D."
date: "April 3, 2018"
output: html_document
---

```{r}
library(tidyverse)
library(leaflet)
library(sf)
library(macleish)
```

```{r}
#Attaining the orchard live weather data from Professor Baumer's R package (this part is not our code)
macleish <- etl("macleish")
macleish %>%
  etl_update()
whately <- macleish %>%
  tbl("whately")
whately %>%
  mutate(the_year = strftime('%Y', when)) %>%
  group_by(the_year) %>%
  summarize(N = n(), begin = min(when), end = max(when), avg_temp = mean(temperature))
orchard <- macleish %>%
  tbl("orchard")
orchard %>%
  mutate(the_year = strftime('%Y', when)) %>%
  group_by(the_year) %>%
  summarize(N = n(), begin = min(when), end = max(when), avg_temp = mean(temperature))

#Collecting the wild not-data sets that orchard and whately are, getting the sap data and the forest data (this part is our code)
orchard_data <-collect(orchard)
whately_data <- collect(whately)
sap <- macleish::maple_sap
forests <- macleish_layers[["forests"]]
```

```{r}
#What types of maple forests are there? Where are they?

forests <- forests%>%
  rename("forest_type"="Sheet1__Na")%>%
  mutate(area= st_area(forests))

forest_areas <- forests %>%
  group_by(forest_type)%>%
  summarise(total_area= sum(area))%>%
  filter(str_detect(forest_type, "Maple"))

#Making a palette for the two types of Maple forests
fm_pal <- colorFactor(
  palette= c('#42f47a', '#137a33'),
  domain= forest_areas$forest_type
)

#Leaflet plot to map where the maple forests are

leaflet()%>%
  addTiles()%>%
  addPolygons(data=forest_areas, color= ~fm_pal(forest_type))
  
```

```{r}
#Wrangling the orchard and whately data

orchard_data$Date <- format(as.POSIXct(orchard_data$when, format= "%Y-%m-%dT%H:%M:%SZ"), "%Y-%m-%d")
orchard_data$Year <- format(as.POSIXct(orchard_data$when, format= "%Y-%m-%dT%H:%M:%SZ"), "%Y")
orchard_data$Month <- format(as.POSIXct(orchard_data$when, format="%Y-%m-%dT%H:%M:%SZ"), "%m")
orchard_data$Day <- format(as.POSIXct(orchard_data$when, format="%Y-%m-%dT%H:%M:%SZ"), "%d")
orchard_data$Time <- format(as.POSIXct(orchard_data$when, format="%Y-%m-%dT%H:%M:%SZ"), "%H.%M%S")

whately_data$Date <- format(as.POSIXct(whately_data$when, format= "%Y-%m-%dT%H:%M:%SZ"), "%Y-%m-%d")
whately_data$Year <- format(as.POSIXct(whately_data$when,format=("%Y-%m-%dT%H:%M:%SZ")),"%Y")
whately_data$Month <- format(as.POSIXct(whately_data$when,format=("%Y-%m-%dT%H:%M:%SZ")),"%m")
whately_data$Day <- format(as.POSIXct(whately_data$when,format=("%Y-%m-%dT%H:%M:%SZ")),"%d")
whately_data$Time <- format(as.POSIXct(whately_data$when, format="%Y-%m-%dT%H:%M:%SZ"), "%H.%M%S")
```

```{r}
#more wrangling

Night_weather <- function(name_arg){
  na.omit(name_arg)%>%
  transform(temperature= as.numeric(temperature),
            wind_speed= as.numeric(wind_speed),
            wind_dir = as.numeric(wind_dir),
            rel_humidity= as.numeric(rel_humidity),
            pressure= as.numeric(pressure))%>%
  filter(Time< 6|Time > 18)%>%
  select(temperature:Day)%>%
  group_by(Year, Month, Day)%>%
  summarise(min_night_temp = min(temperature),
            night_wind_speed = mean(wind_speed),
            night_wind_dir = mean(wind_dir),
            night_rel_humidity = mean(rel_humidity),
            night_pressure = mean(pressure))%>%
    filter(min_night_temp < 0)
}

Day_weather <- function(name_arg){
  na.omit(name_arg)%>%
  transform(temperature= as.numeric(temperature),
            wind_speed= as.numeric(wind_speed),
            wind_dir = as.numeric(wind_dir),
            rel_humidity= as.numeric(rel_humidity),
            pressure= as.numeric(pressure))%>%
  filter(Time>6|Time<18)%>%
  select(temperature:Day)%>%
  group_by(Year, Month, Day)%>%
  summarise(max_day_temp = max(temperature),
            day_wind_speed = mean(wind_speed),
            day_wind_dir = mean(wind_dir),
            day_rel_humidity = mean(rel_humidity),
            day_pressure = mean(pressure))%>%
    filter(max_day_temp > 0)
}

ideal_days <- function(name_arg) {
  Day_weather(name_arg)%>%
    inner_join(Night_weather(name_arg), by = c("Year", "Month", "Day"))
}

```

```{r}
#using those functions

Whately_Weather <- ideal_days(whately_data)

#the orchard weather is really only for ground temperatures and in the middle of a field, whearas the whately station is in the forest and gets readings from the air so it's more useful. 
Orchard_Weather <- ideal_days(orchard_data)

```

```{r}
#wrangling the sap data a bit

sap$Year <- format(as.POSIXct(sap$when, format= "%Y-%m-%d"), "%Y")
sap$Month <- format(as.POSIXct(sap$when, format="%Y-%m-%d"), "%m")
sap$Day <- format(as.POSIXct(sap$when, format="%Y-%m-%d"), "%d")

Sap <- sap %>%
  rename("Sap_in_gal"="sap")%>%
  select(Sap_in_gal, Year:Day)

WW_and_Sap <- Whately_Weather %>%
  left_join(Sap, by = c("Year", "Month", "Day"))
```